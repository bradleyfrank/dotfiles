#!/usr/bin/env bash

# @meta describe Utility scripts for tmux
# @meta author Brad Frank
# @meta require-tools tmux,fzf
# @meta combine-shorts
#


_get_window_name() {
  local cwd base_cwd username branch_name repo_name

  cwd="$1"
  base_cwd="$(basename "$cwd")"
  repo_name="$base_cwd"
  username="$(id --user --name)"

  pushd "$cwd" &> /dev/null || exit 1

  if branch_name="$(git branch --show-current 2>/dev/null)"; then
    [[ "$base_cwd" == "$branch_name" ]] && repo_name="$(basename "$(dirname "$cwd")")"
    echo "${repo_name} (${branch_name})"
  elif [[ "$base_cwd" == "$username" ]]; then
    echo "~${username}"
  else
    echo "$base_cwd"
  fi

  popd &> /dev/null || exit 1
}


_get_project_dir() {
  find "${HOME}/Development/Projects" -mindepth 2 -maxdepth 2 -type d \
    | fzf-tmux -p --reverse --no-multi --delimiter / --with-nth -2,-1 \
    --preview="eza --color always --classify --no-user --no-permissions --long --all --git {} --"
}


_get_layouts() {
  tmux list-keys | sed -rn "s/^bind-key.*M-[0-9]\s+select-layout\s(.*)/\1/p"
}


_select_session() {
  tmux list-session -F "#{session_name}" \
    | fzf-tmux --no-multi -p --preview="tmux list-windows -t {} -F '#{window_name}' --"
}


# @cmd Rename elements
# @flag -w --window window
# @flag -s --session session
# @arg dir!
rename() {
  local window_name; window_name="$(_get_window_name "$argc_dir")"
  [[ -n $argc_window ]] && tmux rename-window "$window_name"
  [[ -n $argc_session ]] && tmux rename-session "$(awk '{print $1}' <<< "$window_name")"
}


# @cmd Open a project in a new window
# @option -d --directory Project directory
# @option -c --command Command to run in new window
# @flag -s --new-session Open the window in a new session
open() {
  local window_name session_name

  [[ -z "$argc_directory" ]] && argc_directory="$(_get_project_dir)"
  [[ -z "$argc_directory" ]] && exit 0

  window_name="$(_get_window_name "$argc_directory")"

  if [[ -n $argc_new_session ]]; then
    session_name="$(awk '{print $1}' <<< "$window_name")"
    if tmux has-session -t "$session_name" 2>/dev/null; then
      tmux new-window -n "$window_name" -c "$argc_directory" -d
    else
      tmux new-session -s "$session_name" -n "$window_name" -c "$argc_directory" -d
    fi
  else
    session_name="$(tmux display-message -p "#S")"
    tmux new-window -n "$window_name" -c "$argc_directory" -d
  fi

  tmux switch-client -t "${session_name}:${window_name}"
  [[ -n "$argc_command" ]] && tmux send-keys -t "${session_name}:${window_name}" "$argc_command" Enter
}


# @cmd Move a window or pane from one session to another
move() { :; }


# @cmd Move a window from one session to another
move::window() {
  local session_name window_name session_index session_window \
    window_to_move target_session target_index
  local -A tmux_windows

  # Create a list of each window in every session
  while read -r session_name; do
    while read -r window_name; do
      session_index="$(awk -F ':' '{print $1}' <<< "$window_name")"
      session_window="$(awk -F ':' '{print $2}' <<< "$window_name")"
      tmux_windows["${session_name}: ${session_window}"]="${session_name}:${session_index}"
    done < <(tmux list-windows -F "#{window_index}:#{window_name}" -t "$session_name")
  done < <(tmux list-sessions -F "#{session_name}")

  [[ ${#tmux_windows[@]} -eq 0 ]] && return 1

  while read -r window_to_move; do
    target_session="$(_select_session)"
    target_index="$(tmux list-windows -F "#{window_index}" -t "$target_session" | tail -n1)"
    tmux move-window \
      -s "${tmux_windows["$window_to_move"]}" -t "${target_session}:${target_index}" -da
  done < <(printf "%s\n" "${!tmux_windows[@]}" | sort | fzf-tmux -p --multi)
}


# @cmd Move a pane from one session to another
move::pane() {
  [[ -z $argc_session ]] && argc_session="$(_select_session)"
}


# @cmd Rearrange tmux panes into new layout
# @arg layout[`_get_layouts`]
layout() {
  [[ -z $argc_layout ]] && argc_layout="$(_get_layouts | fzf-tmux -p --no-multi -1)"
  [[ -z $argc_layout ]] && return 0
  tmux select-layout "$argc_layout"
}


# @cmd Save pane output to file
# @option -o --output <FILE> Output file
dump() {
  local window_name session_name output_dir output_temp

  session_name="$(tmux display-message -p "#{session_name}")"
  output_temp="$(mktemp)"

  if [[ -z $argc_output ]]; then
    argc_output="${HOME}/Development/Logs/$(tmux display-message -p \
      'tmux-%Y-%b-%d-%H%M-#{session_name}.log' | tr -cd '[:print:]')"
  fi

  output_dir="$(dirname "$argc_output")"

  mkdir --parents "$(dirname "$argc_output")"
  tmux capture-pane -S -
  tmux save-buffer "$output_temp"
  cat -s "$output_temp" > "$argc_output"
  rm "$output_temp"

  window_name="$(_get_window_name "$output_dir")"
  tmux new-window -n "${window_name}" -c "$output_dir" -d
  tmux switch-client -t "${session_name}:${window_name}"
  tmux send-keys -t "${session_name}:${window_name}" "vim ${argc_output}; clear" Enter
}


_pwd() { pwd; }


# @cmd Print Git branch of a Git repo
# @option -d --dir=`_pwd` Path to Git repo
branch() {
  local git_branch
  cd "$1" || exit
  if git_branch="$(git branch --show-current 2>/dev/null)"; then
    echo -e "#[fg=colour64]${git_branch}#[fg=default]"
  else
    echo -e "#[fg=colour64]n/a#[fg=default]"
  fi
}


# @cmd Save session (tmux-resurrect)
save() {
  "${HOME}/.local/share/tmux-resurrect/scripts/save.sh"
}


eval "$(argc --argc-eval "$0" "$@")"
