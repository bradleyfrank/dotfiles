#!/usr/bin/env bash

# @meta describe Renames media downloaded from torrents
# @meta author Brad Frank
# @meta require-tools mnamer
# @meta combine-shorts

DEST_MOVIES="${HOME}/Movies/Plex/movies"
DEST_TV="${HOME}/Movies/Plex/tv_shows"


# @option -m --movie <DIR+>
# @option -t --tv <DIR+>
main() {
  if [[ -n $argc_movie || -n $argc_tv ]]; then
    for dir in "${argc_movie[@]}"; do  movies "$dir";    done
    for dir in "${argc_tv[@]}"; do     tv_shows "$dir";  done
  else
    mnamer ./* \
      --movie-directory "${DEST_MOVIES}/" \
      --episode-directory "${DEST_TV}/{series}/Season_{season:02}" \
      --movie-format "{name}.{year}{extension}" \
      --episode-format "S{season:02}E{episode:02}.{title}{extension}"
  fi

  rename --subst-all "'" "" --sanitize "$DEST_MOVIES"/**/*
  rename --subst-all "'" "" --sanitize "$DEST_TV"/**/*
}


movies() {
  local title dir; dir="$1"

  cd "$dir" || exit 1

  find . -mindepth 1 -type f ! -name '*.srt' ! -name '*.mp4' -delete
  find . -mindepth 2 -type f -iname '*eng*.srt' -exec mv --target-directory ./ -- {} \+
  find . -mindepth 1 -type d -exec rm -rf {} \+
  find . -type f -name '*.srt' -printf '%s\t%p\n' \
    | sort --numeric-sort \
    | head --lines -1 \
    | awk --field-separator '\t' '{print $2}' \
    | xargs --no-run-if-empty -I {} rm {} \;

  title="$(find . -name '*.mp4' -printf '%P\n' \
    | tr '.' '_' \
    | tr '[:lower:]' '[:upper:]' \
    | sed 's/[^a-zA-Z0-9_]//g'
  )"

  # regex search for edition, which should be between release year and resolution
  edition="$(sed --regexp-extended --quiet \
    's/.*(19|20)[0-9]{2}_(.*)_[0-9]{3,4}p.*/\2/p' <<< "$title")"
  if [[ -n "$edition" ]]; then edition="{edition-${edition}}."; fi

  mnamer ./*.mp4 --batch --movie-format "{name}.{year}.${edition}mp4"

  title="$(basename -s .mp4 -- *.mp4)"
  mv --no-clobber "$(find . -name '*.srt' -printf '%P\n')" "${title}.eng.srt"

  dir_original="$(sed 's:/*$::' <<< "$dir")"
  dir_rename="$(sed 's/{edition-.*}\.//g' <<< "$title")"

  if [[ "$dir_original" != "$dir_rename" ]]; then
    mv ./"$dir_original" "${DEST_MOVIES}/${dir_rename}"
  fi
}


tv_shows() {
  local dir; dir="$1"

  cd "$dir" || exit 1

  mnamer ./* \
    --batch \
    --episode-directory "${HOME}/Movies/Plex/tv_shows/{series}/Season_{season:02}" \
    --episode-format "S{season:02}E{episode:02}.{title}{extension}"
}


# @cmd Sort media in the 'upload' directory into movie decade directory (server-side)
sort() {
  cd /data/media/movies || exit 1

  decade="$(date +%Y | cut --characters 1-3 | xargs -I {} echo "{} + 1" | bc)"
  year="$(find . -maxdepth 1 -mindepth 1 -type d -printf '%P\n' \
    | sort --numeric-sort \
    | head --lines 1 \
    | cut --characters 1-3 \
  )"

  cd /data/media/upload || exit 1

  while (( year < decade )); do
    find . -maxdepth 1 -regex ".*\.${year}[0-9]\(\..*\|$\)" -exec mv {} "../movies/${year}0/" \+
    year=$(( year+1 ))
  done
}


eval "$(argc --argc-eval "$0" "$@")"
